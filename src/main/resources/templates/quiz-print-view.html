<!DOCTYPE html>
<html xml:lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|Result: ${studentId}|">Exam Results</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        /* =========================================
           1. CONFIGURATION & VARIABLES
           ========================================= */
        :root {
            --font-serif: "Noto Serif JP", serif;
            --font-sans: "Noto Sans JP", sans-serif;
            --c-ink: #000;
            --c-paper: #fff;
            --border-thick: 2px solid #000;
            --border-thin: 1px solid #000;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-serif);
            color: var(--c-ink);
            background: #555;
            /* Screen background */
            margin: 0;
            padding: 20px;
        }

        /* =========================================
           2. PAPER SIMULATION (A4)
           ========================================= */
        .sheet {
            background: var(--c-paper);
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 10mm;
            /* Compact padding */
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* =========================================
           3. UI CONTROLS (Screen Only)
           ========================================= */
        .controls {
            max-width: 210mm;
            margin: 0 auto 10px auto;
            display: flex;
            justify-content: space-between;
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn {
            padding: 6px 12px;
            border: 2px solid #333;
            background: #fff;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: #eee;
        }

        .btn.active {
            background: #333;
            color: #fff;
        }

        /* =========================================
           4. HEADER SECTION 
           ========================================= */
        .header-section {
            border-bottom: var(--border-thick);
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 20px;
            align-items: start;
        }

        .header-info h1 {
            font-family: var(--font-sans);
            font-size: 1.5rem;
            margin: 0 0 5px 0;
            text-transform: uppercase;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 2px 15px;
            font-size: 0.85rem;
            align-items: baseline;
        }

        .meta-label {
            font-weight: bold;
            font-family: var(--font-sans);
            white-space: nowrap;
        }

        .score-box {
            border: var(--border-thick);
            padding: 5px;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .score-val {
            font-size: 2rem;
            font-weight: 900;
            line-height: 1;
            display: block;
        }

        .score-max {
            font-size: 0.8rem;
            border-top: 1px solid #000;
            display: block;
            margin-top: 2px;
            padding-top: 2px;
        }

        /* =========================================
           5. QUESTIONS LAYOUT (Compact)
           ========================================= */
        .question-block {
            margin-bottom: 15px;
            page-break-inside: avoid;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 10px;
        }

        /* Combined Meta and Text Container */
        .q-header-combined {
            margin-bottom: 8px;
            line-height: 1.4;
        }

        /* Status Badges */
        .status-badge {
            border: 1px solid #000;
            padding: 1px 6px;
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: bold;
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle;
            transform: translateY(-2px);
        }

        .status-correct {
            background: #fff;
            color: #000;
        }

        .status-wrong {
            background: #000;
            color: #fff;
        }

        /* NEW: Unanswered Badge Style */
        .status-unanswered {
            background: #fff;
            color: #000;
            border: 1px dashed #000;
        }

        .q-text-inline {
            font-weight: 500;
            font-size: 1rem;
            display: inline;
        }

        /* Options Layout - 2 Columns & Indented */
        .options-list {
            list-style: none;
            padding: 0;
            margin: 0 0 0 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            column-gap: 15px;
            row-gap: 2px;
        }

        .opt-row {
            display: flex;
            align-items: flex-start;
            padding: 2px 0;
            position: relative;
            font-size: 0.9rem;
        }

        .opt-check {
            width: 14px;
            height: 14px;
            border: 1.5px solid #000;
            margin-right: 6px;
            margin-top: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .selected .opt-check {
            background: #000;
        }

        .selected .opt-check::after {
            content: "";
            width: 4px;
            height: 4px;
            background: #fff;
            display: block;
        }

        .correct-key {
            font-weight: bold;
        }

        .correct-key::after {
            content: " (KEY)";
            font-size: 0.65em;
            font-family: var(--font-sans);
            border: 1px solid #000;
            padding: 0px 3px;
            margin-left: 4px;
            vertical-align: middle;
        }

        .selected-wrong .opt-text {
            text-decoration: line-through;
        }

        /* Feedback Section */
        .feedback-container {
            margin-top: 5px;
            padding: 3px 5px;
            border-left: 2px solid #666;
            background-color: #f9f9f9;
            font-size: 0.85rem;
            font-style: italic;
            margin-left: 20px;
        }

        .section-title {
            text-align: center;
            font-family: var(--font-sans);
            font-weight: 700;
            font-size: 1.2rem;
            border-top: 1px solid #000;
            border-bottom: 1px solid #000;
            padding: 3px;
            margin: 20px 0 10px 0;
            background: #f9f9f9;
        }

        /* =========================================
           6. MODES
           ========================================= */

        /* Study Mode (Hides everything) */
        body.study-mode .score-box {
            visibility: hidden;
        }

        body.study-mode .status-badge {
            display: none;
        }

        body.study-mode .correct-key::after {
            display: none;
        }

        body.study-mode .selected-wrong .opt-text {
            text-decoration: none;
        }

        body.study-mode .selected .opt-check {
            background: transparent;
        }

        body.study-mode .selected .opt-check::after {
            display: none;
        }

        body.study-mode .feedback-container {
            display: none;
        }

        body.study-mode .retake-section {
            display: none;
        }

        /* Retake Section (Always Blank Worksheet Style) */
        .retake-section .score-box,
        .retake-section .status-badge,
        .retake-section .correct-key::after,
        .retake-section .selected .opt-check::after,
        .retake-section .feedback-container {
            display: none;
        }

        .retake-section .selected .opt-check {
            background: transparent;
        }

        .retake-section .selected-wrong .opt-text {
            text-decoration: none;
        }

        .retake-section .question-block {
            border-bottom: 1px solid #eee;
        }

        /* =========================================
           7. PRINT
           ========================================= */
        @media print {
            body {
                background: none;
                padding: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .controls {
                display: none;
            }

            .sheet {
                width: 100%;
                box-shadow: none;
                padding: 0;
                margin: 0;
            }

            .question-block {
                break-inside: avoid;
            }

            .page-break-before {
                break-before: page;
                page-break-before: always;
            }
        }
    </style>
</head>

<body>

    <div class="controls no-print">
        <div style="display:flex; gap:10px; align-items:center;">
            <strong>Print Options:</strong>
            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print</button>
            <button class="btn" id="btnToggleStudy" onclick="toggleStudyMode()">Mode: Review</button>
        </div>
    </div>

    <div class="sheet">
        <header class="header-section">
            <div class="header-info">
                <h1 th:text="${quizTitle}">Quiz Title</h1>
                <div class="meta-grid">
                    <span class="meta-label">Student:</span>
                    <span th:text="${studentName}">Name</span>

                    <span class="meta-label">ID:</span>
                    <span th:text="${studentId}">12345</span>

                    <span class="meta-label">Date:</span>
                    <span id="printDate">2023-10-27</span>
                </div>
            </div>

            <div class="score-box">
                <span class="score-val" th:text="${score}">88</span>
                <span class="score-max">/ <span th:text="${pointsPossible}">100</span> PTS</span>
            </div>
        </header>

        <!-- MAIN REVIEW SECTION -->
        <div class="questions-wrapper">
            <div th:each="q : ${questions}" class="question-block">

                <!-- Logic: hasWrong is true if student selected a wrong answer -->
                <!-- q.isUnanswered is true if student selected NO answers -->
                <div th:remove="tag" th:with="hasWrong=${#aggregates.sum(q.options.![isSelectedAndWrong ? 1 : 0]) > 0}">

                    <div class="q-header-combined">
                        <!-- Correct: ONLY if not wrong AND not unanswered -->
                        <span class="status-badge status-correct" th:if="${!hasWrong && !q.isUnanswered}">Correct</span>

                        <!-- Review: If student actively selected wrong answer -->
                        <span class="status-badge status-wrong" th:if="${hasWrong}">Review</span>

                        <!-- Unanswered: If student didn't answer -->
                        <span class="status-badge status-unanswered" th:if="${q.isUnanswered}">Unanswered</span>

                        <!-- Question Text inline -->
                        <span class="q-text-inline" th:utext="${q.questionHtml}">Question Text</span>
                    </div>

                    <ul class="options-list">
                        <li th:each="opt : ${q.options}" class="opt-row"
                            th:classappend="${opt.isSelected ? 'selected' : ''} + ' ' + ${opt.isSelectedAndWrong ? 'selected-wrong' : ''} + ' ' + ${opt.isCorrect ? 'correct-key' : ''}">

                            <!-- Visual Checkbox -->
                            <div class="opt-check"></div>
                            <div class="opt-text" th:text="${opt.text}">Option Text</div>
                        </li>
                    </ul>

                    <!-- Simple Feedback Span -->
                    <div class="feedback-container" th:if="${q.feedbackText != null}">
                        <span th:utext="${q.feedbackText}"></span>
                    </div>

                </div>
            </div>
        </div>

        <!-- RETAKE SECTION -->
        <div class="retake-section" th:if="${!reviewQuestions.empty}">
            <div class="section-title page-break-before">RETAKE INCORRECT QUESTIONS</div>
            <p style="text-align:center; font-style:italic; margin-bottom:10px; font-size: 0.9rem;">
                Practice Area: Attempt these questions again without looking at the key.
            </p>

            <div th:each="q : ${reviewQuestions}" class="question-block">
                <div class="q-header-combined">
                    <!-- Removed Badges for Retake -->
                    <span class="q-text-inline" th:utext="${q.questionHtml}">Question Text</span>
                </div>

                <ul class="options-list">
                    <li th:each="opt : ${q.options}" class="opt-row"
                        th:classappend="${opt.isSelected ? 'selected' : ''} + ' ' + ${opt.isSelectedAndWrong ? 'selected-wrong' : ''} + ' ' + ${opt.isCorrect ? 'correct-key' : ''}">

                        <div class="opt-check"></div>
                        <div class="opt-text" th:text="${opt.text}">Option Text</div>
                    </li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        document.getElementById('printDate').innerText = new Date().toLocaleDateString();

        function toggleStudyMode() {
            const body = document.body;
            const btn = document.getElementById('btnToggleStudy');
            body.classList.toggle('study-mode');

            if (body.classList.contains('study-mode')) {
                btn.innerText = "Mode: Blank Worksheet";
                btn.style.background = "#333";
                btn.style.color = "#fff";
            } else {
                btn.innerText = "Mode: Review Results";
                btn.style.background = "#fff";
                btn.style.color = "#333";
            }
        }
    </script>
</body>

</html>