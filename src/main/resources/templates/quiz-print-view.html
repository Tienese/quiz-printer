<!DOCTYPE html>
<html xml:lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|Result: ${studentId}|">Exam Results</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Serif+JP:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        /* =========================================
           1. CONFIGURATION & VARIABLES
           ========================================= */
        :root {
            --font-serif: "Noto Serif JP", serif;
            --font-sans: "Noto Sans JP", sans-serif;
            --c-ink: #000;
            --c-paper: #fff;
            --border-thick: 2px solid #000;
            --border-thin: 1px solid #000;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-serif);
            color: var(--c-ink);
            background: #555; /* Screen background */
            margin: 0;
            padding: 20px;
        }

        /* =========================================
           2. PAPER SIMULATION (A4)
           ========================================= */
        .sheet {
            background: var(--c-paper);
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 15mm;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* =========================================
           3. UI CONTROLS (Screen Only)
           ========================================= */
        .controls {
            max-width: 210mm;
            margin: 0 auto 15px auto;
            display: flex;
            justify-content: space-between;
            background: #fff;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn {
            padding: 8px 16px;
            border: 2px solid #333;
            background: #fff;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            margin-right: 10px;
        }

        .btn:hover { background: #eee; }
        .btn.active { background: #333; color: #fff; }

        /* =========================================
           4. HEADER SECTION 
           ========================================= */
        .header-section {
            border-bottom: var(--border-thick);
            padding-bottom: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-info h1 {
            font-family: var(--font-sans);
            font-size: 1.8rem;
            margin: 0 0 10px 0;
            text-transform: uppercase;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: auto auto;
            gap: 5px 20px;
            font-size: 0.9rem;
        }

        .meta-label { font-weight: bold; font-family: var(--font-sans); }

        /* Score Badge - High Contrast Box */
        .score-box {
            border: var(--border-thick);
            padding: 10px 20px;
            text-align: center;
            min-width: 120px;
        }
        
        .score-val { font-size: 2.5rem; font-weight: 900; line-height: 1; display: block; }
        .score-max { font-size: 0.9rem; border-top: 1px solid #000; display: block; margin-top: 5px; padding-top: 2px; }

        /* =========================================
           5. QUESTIONS LAYOUT
           ========================================= */
        .question-block {
            margin-bottom: 25px;
            page-break-inside: avoid;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 20px;
        }

        .q-meta {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-family: var(--font-sans);
        }

        .q-num {
            font-weight: 900;
            font-size: 1.2rem;
            margin-right: 10px;
        }

        /* Status Indicators (No Color Reliance) */
        .status-badge {
            border: 1px solid #000;
            padding: 2px 8px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: bold;
            margin-right: 10px;
        }

        .status-correct { background: #fff; color: #000; }
        .status-wrong { background: #000; color: #fff; }

        .q-text {
            font-weight: 500;
            margin-bottom: 15px;
            font-size: 1.05rem;
            line-height: 1.4;
        }

        /* Options Layout */
        .options-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .opt-row {
            display: flex;
            align-items: baseline;
            padding: 6px 0;
            position: relative;
        }

        /* Checkboxes for print simulation */
        .opt-check {
            width: 18px;
            height: 18px;
            border: 2px solid #000;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Styles for Student Selection */
        .selected .opt-check {
            background: #000; /* Filled box for selection */
        }
        
        .selected .opt-check::after {
            content: "";
            width: 6px;
            height: 6px;
            background: #fff;
            display: block;
        }

        /* Styles for Correct Key (if different from selection) */
        .correct-key {
            font-weight: bold;
        }
        
        .correct-key::after {
            content: " (KEY)";
            font-size: 0.7em;
            font-family: var(--font-sans);
            border: 1px solid #000;
            padding: 1px 4px;
            margin-left: 8px;
        }

        /* Strike through wrong answers */
        .selected-wrong .opt-text {
            text-decoration: line-through;
        }

        /* =========================================
           6. LEARNER REFLECTION AREA (The Improvement)
           ========================================= */
        .reflection-area {
            margin-top: 15px;
            border: 2px dotted #999;
            padding: 15px;
            background: #fdfdfd;
            display: none; /* Hidden by default, shown for wrong answers */
        }

        .reflection-title {
            font-family: var(--font-sans);
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }

        .reflection-lines {
            height: 60px;
            background-image: repeating-linear-gradient(white 0px, white 24px, #ccc 25px);
        }

        /* Only show reflection for wrong answers */
        .question-block[data-status="wrong"] .reflection-area {
            display: block;
        }

        /* =========================================
           7. STUDY MODE (Hide Answers)
           ========================================= */
        body.study-mode .score-box { visibility: hidden; }
        body.study-mode .status-badge { display: none; }
        body.study-mode .correct-key::after { display: none; }
        body.study-mode .selected-wrong .opt-text { text-decoration: none; }
        body.study-mode .selected .opt-check { background: transparent; }
        body.study-mode .selected .opt-check::after { display: none; }
        body.study-mode .reflection-area { display: none !important; }
        body.study-mode .feedback { display: none; }

        /* =========================================
           8. PRINT MEDIA QUERIES
           ========================================= */
        @media print {
            body { 
                background: none; 
                padding: 0; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .controls { display: none; }
            .sheet { width: 100%; box-shadow: none; padding: 0; margin: 0; }
            
            /* Force page breaks */
            .question-block { break-inside: avoid; }
        }
    </style>
</head>

<body>

    <div class="controls no-print">
        <div style="display:flex; gap:10px; align-items:center;">
            <strong>Print Options:</strong>
            <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è Print</button>
            <button class="btn" id="btnToggleStudy" onclick="toggleStudyMode()">Mode: Review</button>
        </div>
    </div>

    <div class="sheet">
        <header class="header-section">
            <div class="header-info">
                <h1 th:text="${quizTitle}">Quiz Title</h1>
                <div class="meta-grid">
                    <span class="meta-label">Student:</span>
                    <span th:text="${studentName}">Name</span>
                    
                    <span class="meta-label">ID:</span>
                    <span th:text="${studentId}">12345</span>
                    
                    <span class="meta-label">Date:</span>
                    <span id="printDate">2023-10-27</span>
                </div>
            </div>
            
            <div class="score-box">
                <span class="score-val" th:text="${score}">88</span>
                <span class="score-max">/ <span th:text="${pointsPossible}">100</span> PTS</span>
            </div>
        </header>

        <div class="questions-wrapper">
            <div th:each="q : ${questions}" class="question-block"
                 th:attr="data-status=${#aggregates.sum(q.options.![isSelectedAndWrong ? 1 : 0]) > 0 ? 'wrong' : 'correct'}">
                
                <div th:remove="tag" th:with="hasWrong=${#aggregates.sum(q.options.![isSelectedAndWrong ? 1 : 0]) > 0}">
                    
                    <div class="q-meta">
                        <span class="q-num" th:text="'Q' + ${q.questionNumber} + '.'">1.</span>
                        <span class="status-badge status-correct" th:if="${!hasWrong}">Correct</span>
                        <span class="status-badge status-wrong" th:if="${hasWrong}">Review Needed</span>
                    </div>

                    <div class="q-text" th:utext="${q.questionHtml}">Question Text</div>

                    <ul class="options-list">
                        <li th:each="opt : ${q.options}" class="opt-row" 
                            th:classappend="${opt.isSelected ? 'selected' : ''} + ' ' + ${opt.isSelectedAndWrong ? 'selected-wrong' : ''} + ' ' + ${opt.isCorrect ? 'correct-key' : ''}">
                            
                            <!-- Visual Checkbox -->
                            <div class="opt-check"></div>
                            <div class="opt-text" th:text="${opt.text}">Option Text</div>
                        </li>
                    </ul>

                    <!-- Improvement: Learner Reflection Area for Wrong Answers -->
                    <div class="reflection-area">
                        <span class="reflection-title">My Correction Notes (Why did I miss this?):</span>
                        <div class="reflection-lines"></div>
                        <div style="margin-top:10px; font-size:0.85em; font-style:italic;" th:if="${q.feedbackText != null}">
                            <strong>Instructor Feedback:</strong> <span th:utext="${q.feedbackText}"></span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('printDate').innerText = new Date().toLocaleDateString();

        function toggleStudyMode() {
            const body = document.body;
            const btn = document.getElementById('btnToggleStudy');
            body.classList.toggle('study-mode');
            
            if (body.classList.contains('study-mode')) {
                btn.innerText = "Mode: Blank Worksheet";
                btn.style.background = "#333";
                btn.style.color = "#fff";
            } else {
                btn.innerText = "Mode: Review Results";
                btn.style.background = "#fff";
                btn.style.color = "#333";
            }
        }
    </script>
</body>
</html>