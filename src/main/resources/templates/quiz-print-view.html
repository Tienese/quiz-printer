<!DOCTYPE html>
<html xml:lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|Result: ${studentId}|">Exam Results</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        /* =========================================
           1. SETUP & UTILITIES
           ========================================= */
        :root {
            --f-serif: "Noto Serif JP", serif;
            --f-sans: "Noto Sans JP", sans-serif;
            --sz-base: 10pt;
            /* K√≠ch th∆∞·ªõc t·ªëi ∆∞u cho in ·∫•n m·∫≠t ƒë·ªô cao */
            --sz-sm: 9pt;
            --lh-tight: 1.3;
        }

        @page {
            size: A4;
            margin: 15mm;
            /* Chu·∫©n in ·∫•n ti·∫øt ki·ªám */
        }

        * {
            box-sizing: border-box;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        body {
            font-family: var(--f-serif);
            font-size: var(--sz-base);
            line-height: var(--lh-tight);
            color: #000;
            background: #fff;
            margin: 0;
            padding: 0;
        }

        /* ·∫®n UI ƒëi·ªÅu khi·ªÉn khi in */
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                padding: 0;
            }
        }

        /* =========================================
           2. HEADER (Compact 3 Lines)
           ========================================= */
        .header-compact {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .header-left h1 {
            font-family: var(--f-sans);
            font-size: 14pt;
            margin: 0;
            text-transform: uppercase;
            font-weight: 700;
        }

        .meta-line {
            font-size: var(--sz-sm);
            margin-top: 2px;
        }

        .meta-line span {
            margin-right: 15px;
        }

        .score-compact {
            text-align: right;
            line-height: 1;
        }

        .score-val {
            font-size: 18pt;
            font-weight: 700;
            font-family: var(--f-sans);
        }

        .score-total {
            font-size: 9pt;
            display: block;
        }

        /* =========================================
           3. QUESTION BLOCK (High Density)
           ========================================= */
        .q-block {
            margin-bottom: 8px;
            /* Kho·∫£ng c√°ch gi·ªØa c√°c c√¢u c·ª±c nh·ªè */
            break-inside: avoid;
            /* Tr√°nh b·ªã ng·∫Øt gi·ªØa trang */
            page-break-inside: avoid;
        }

        .q-line {
            display: block;
            margin-bottom: 3px;
            font-weight: 500;
        }

        /* Markers: ‚úì ‚úó ‚ñ≤ */
        .marker {
            font-family: var(--f-sans);
            font-weight: bold;
            display: inline-block;
            width: 15px;
            /* C·ªë ƒë·ªãnh ƒë·ªô r·ªông ƒë·ªÉ th·∫≥ng h√†ng */
        }

        .m-correct {
            color: #000;
        }

        .m-wrong {
            color: #000;
            text-decoration: underline;
        }

        /* Underline ƒë·ªÉ nh·∫•n m·∫°nh in ƒëen tr·∫Øng */
        .m-miss {
            font-size: 0.8em;
        }

        /* =========================================
           4. OPTIONS (Compact Grid)
           ========================================= */
        .opt-list {
            list-style: none;
            padding: 0 0 0 20px;
            /* Th·ª•t ƒë·∫ßu d√≤ng nh·∫π */
            margin: 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            /* 2 C·ªôt ƒë·ªÉ ti·∫øt ki·ªám chi·ªÅu d·ªçc */
            column-gap: 10px;
            row-gap: 5px;
            /* TƒÉng nh·∫π gap d√≤ng ƒë·ªÉ ch·ª©a feedback */
            counter-reset: opt-counter;
            /* Kh·ªüi t·∫°o b·ªô ƒë·∫øm ABC */
        }

        .opt-item {
            position: relative;
            font-size: var(--sz-sm);
            display: flex;
            align-items: baseline;
            flex-wrap: wrap;
            /* Cho ph√©p xu·ªëng d√≤ng n·∫øu c·∫ßn (cho feedback) */
        }

        /* T·ª± ƒë·ªông sinh [A] [B] [C] */
        .opt-item::before {
            counter-increment: opt-counter;
            content: "[" counter(opt-counter, upper-alpha) "]";
            font-family: var(--f-sans);
            font-weight: bold;
            font-size: 0.85em;
            margin-right: 5px;
            min-width: 25px;
        }

        /* Styling cho l·ª±a ch·ªçn c·ªßa user */
        .user-selected {
            font-weight: bold;
        }

        /* ƒê√°nh d·∫•u visual cho l·ª±a ch·ªçn */
        .mark-circle {
            margin-left: 5px;
            font-size: 1.1em;
        }

        /* ‚óè / ‚óã */

        /* Key Correct hi·ªÉn th·ªã b√™n c·∫°nh */
        .key-badge {
            font-size: 0.75em;
            border: 1px solid #000;
            padding: 0 2px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* =========================================
           5. FEEDBACK (Minimalist)
           ========================================= */
        /* General Question Feedback */
        .fb-compact {
            font-size: 8pt;
            font-style: italic;
            color: #444;
            margin-left: 20px;
            margin-top: 2px;
            border-left: 1px dotted #000;
            padding-left: 5px;
        }

        /* Specific Option Feedback (N·∫±m d∆∞·ªõi option) */
        .opt-item .fb-compact {
            width: 100%;
            /* Chi·∫øm to√†n b·ªô d√≤ng m·ªõi */
            margin-left: 30px;
            /* Th·ª•t ƒë·∫ßu d√≤ng ƒë·ªÉ tr√°nh ƒë√® l√™n [A] */
            margin-top: 1px;
            border: none;
            /* B·ªè border th·ª´a */
            display: block;
            color: #555;
        }

        /* =========================================
           6. RETAKE SECTION (Checklist Style)
           ========================================= */
        .retake-area {
            margin-top: 20px;
            border-top: 2px dashed #000;
            padding-top: 10px;
        }

        .retake-title {
            font-family: var(--f-sans);
            font-weight: bold;
            font-size: 11pt;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        /* Checkbox ·∫£o cho b·∫£n in */
        .checkbox-print {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 1px solid #000;
            margin-right: 8px;
            transform: translateY(2px);
        }

        /* Screen Controls CSS */
        .screen-controls {
            padding: 10px;
            background: #eee;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            font-family: sans-serif;
        }

        .btn {
            background: #fff;
            border: 1px solid #000;
            padding: 5px 15px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn:hover {
            background: #000;
            color: #fff;
        }

        /* Ch·∫ø ƒë·ªô Blank Worksheet (Study Mode) */
        body.mode-blank .score-compact,
        body.mode-blank .marker,
        body.mode-blank .key-badge,
        body.mode-blank .fb-compact,
        body.mode-blank .mark-circle,
        body.mode-blank .retake-area {
            display: none !important;
        }

        body.mode-blank .user-selected {
            font-weight: normal;
            /* B·ªè in ƒë·∫≠m l·ª±a ch·ªçn c·ªßa user */
        }
    </style>
</head>

<body>

    <!-- UI ƒêi·ªÅu khi·ªÉn (Kh√¥ng in ra) -->
    <div class="screen-controls no-print">
        <button class="btn" onclick="window.print()">üñ®Ô∏è Print Result</button>
        <button class="btn" id="btnMode" onclick="toggleMode()">Mode: With Answers</button>
        <span style="margin-left:10px; font-size:0.9em">Tip: Set margins to "Minimum" in print dialog.</span>
    </div>

    <!-- Header Section (3 D√≤ng t·ªëi ƒëa) -->
    <header class="header-compact">
        <div class="header-left">
            <h1 th:text="${quizTitle}">JAPANESE N3 PRACTICE TEST</h1>
            <div class="meta-line">
                <span th:text="|Student: ${studentName} (${studentId})|">Student Name (ID)</span>
                <span th:text="|Date: ${#dates.format(#dates.createNow(), 'dd/MM/yyyy')}|">Date</span>
            </div>
            <div class="meta-line">
                <span th:text="|Time: ${timeSpent} / ${timeLimit} min|">Time</span>
                <span th:text="|Attempt: #${attempt}|">Attempt #1</span>
            </div>
        </div>
        <div class="score-compact">
            <span class="score-val" th:text="${score}">85</span>
            <span class="score-total" th:text="|/ ${pointsPossible} PTS|">/ 100 PTS</span>
        </div>
    </header>

    <!-- Main Questions List -->
    <div class="quiz-body">
        <div th:each="q, qStat : ${questions}" class="q-block">

            <!-- Logic check status -->
            <div th:remove="tag" th:with="hasWrong=${#aggregates.sum(q.options.![isSelectedAndWrong ? 1 : 0]) > 0}">

                <div class="q-line">
                    <!-- Status Markers: Ti·∫øt ki·ªám m·ª±c -->
                    <span class="marker m-correct" th:if="${!hasWrong && !q.isUnanswered}">‚úì</span>
                    <span class="marker m-wrong" th:if="${hasWrong}">‚úó</span>
                    <span class="marker m-miss" th:if="${q.isUnanswered}">‚ñ≤</span>

                    <!-- Question Text -->
                    <span th:utext="${qStat.count + '. ' + q.questionHtml}">1. Question text here...</span>
                </div>

                <ul class="opt-list">
                    <li th:each="opt : ${q.options}" class="opt-item"
                        th:classappend="${opt.isSelected ? 'user-selected' : ''}">

                        <!-- Text -->
                        <span th:text="${opt.text}">Option text</span>

                        <!-- User Selection Marker (‚óè / ‚óã) -->
                        <span class="mark-circle" th:if="${opt.isSelected}">‚óè</span>

                        <!-- Correct Key Badge (Ch·ªâ hi·ªán [KEY] nh·ªè g·ªçn) -->
                        <span class="key-badge" th:if="${opt.isCorrect}">KEY</span>

                        <!-- Inline Option Feedback (n·∫±m d∆∞·ªõi) -->
                        <span class="fb-compact" th:if="${opt.feedback != null && !opt.feedback.isEmpty()}"
                            th:utext="${opt.feedback}"></span>
                    </li>
                </ul>

                <!-- General Feedback (Gom g·ªçn) -->
                <div class="fb-compact" th:if="${q.feedbackText != null && !q.feedbackText.isEmpty()}">
                    <span th:utext="${q.feedbackText}">Explanation text...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Retake List (Si√™u ti·∫øt ki·ªám - Ch·ªâ list c√¢u h·ªèi sai) -->
    <div class="retake-area" th:if="${!reviewQuestions.empty}">
        <div class="retake-title">Retake / Correction List</div>
        <div style="font-size: 9pt; font-style: italic; margin-bottom: 5px;">
            Questions marked with (‚òê) for manual retake.
        </div>

        <div th:each="q, qStat : ${reviewQuestions}" class="q-block" style="padding-bottom: 5px;">
            <div class="q-line" style="display: flex;">
                <span class="checkbox-print"></span> <!-- Checkbox ‚òê -->
                <span th:utext="${q.questionHtml}" style="margin-left: 5px;">Question content</span>
            </div>

            <!-- Options (Kh√¥ng hi·ªán ƒë√°p √°n ƒë√∫ng, ch·ªâ hi·ªán options ƒë·ªÉ ch·ªçn l·∫°i) -->
            <ul class="opt-list">
                <li th:each="opt : ${q.options}" class="opt-item">
                    <span th:text="${opt.text}">Option A</span>
                </li>
            </ul>
        </div>
    </div>

    <script>
        function toggleMode() {
            const body = document.body;
            const btn = document.getElementById('btnMode');
            body.classList.toggle('mode-blank');
            if (body.classList.contains('mode-blank')) {
                btn.innerText = "Mode: Blank (Worksheet)";
            } else {
                btn.innerText = "Mode: With Answers";
            }
        }
    </script>
</body>

</html>